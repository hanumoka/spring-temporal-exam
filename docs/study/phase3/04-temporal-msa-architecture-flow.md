# Temporal + MSA 아키텍처 흐름도

> **목표**: Temporal 구성요소와 MSA 서비스의 관계를 완전히 이해
> **작성일**: 2026-02-05

---

## 1. 전체 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                              전체 시스템 아키텍처                                        │
│                                                                                         │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   ┌─────────────┐                                                                       │
│   │   Client    │  POST /api/temporal/orders                                           │
│   │  (Browser/  │  {customerId:1, productId:1, quantity:2, amount:20000}               │
│   │   Postman)  │                                                                       │
│   └──────┬──────┘                                                                       │
│          │                                                                              │
│          │ HTTP (REST)                                                                  │
│          ▼                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                                                                  │  │
│   │   orchestrator-temporal (포트: 21081)                                           │  │
│   │   ════════════════════════════════════                                           │  │
│   │                                                                                  │  │
│   │   ┌────────────────────┐     ┌────────────────────────────────────────────┐     │  │
│   │   │   OrderController  │     │              Worker (내장)                  │     │  │
│   │   │                    │     │   ┌──────────────────────────────────────┐ │     │  │
│   │   │ • REST API 수신    │     │   │  Workflow Poller                     │ │     │  │
│   │   │ • WorkflowClient로 │     │   │  • Task Queue 폴링                   │ │     │  │
│   │   │   Workflow 시작    │     │   │  • OrderWorkflowImpl 실행            │ │     │  │
│   │   │                    │     │   └──────────────────────────────────────┘ │     │  │
│   │   └─────────┬──────────┘     │   ┌──────────────────────────────────────┐ │     │  │
│   │             │                │   │  Activity Poller                     │ │     │  │
│   │             │                │   │  • Task Queue 폴링                   │ │     │  │
│   │             │                │   │  • OrderActivitiesImpl 실행          │ │     │  │
│   │             │                │   └──────────────────────────────────────┘ │     │  │
│   │             │                └───────────────────┬────────────────────────┘     │  │
│   │             │                                    │                              │  │
│   └─────────────┼────────────────────────────────────┼──────────────────────────────┘  │
│                 │                                    │                                 │
│                 │ gRPC                               │ gRPC (Poll/Result)              │
│                 │ (StartWorkflow)                    │                                 │
│                 ▼                                    ▼                                 │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                                                                  │  │
│   │   Temporal Server (포트: 21733)                                                 │  │
│   │   ═══════════════════════════════                                                │  │
│   │                                                                                  │  │
│   │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                │  │
│   │   │ Frontend Service│  │ History Service │  │ Matching Service│                │  │
│   │   │                 │  │                 │  │                 │                │  │
│   │   │ • API Gateway   │  │ • Event History │  │ • Task Queue    │                │  │
│   │   │ • 인증/인가     │  │   저장/관리     │  │   관리          │                │  │
│   │   │ • 라우팅        │  │ • Workflow 상태 │  │ • Worker 매칭   │                │  │
│   │   │                 │  │   관리          │  │                 │                │  │
│   │   └─────────────────┘  └────────┬────────┘  └─────────────────┘                │  │
│   │                                 │                                               │  │
│   │                                 │ SQL                                           │  │
│   │                                 ▼                                               │  │
│   │                     ┌─────────────────────┐                                     │  │
│   │                     │ Temporal PostgreSQL │                                     │  │
│   │                     │    (포트: 21432)    │                                     │  │
│   │                     │                     │                                     │  │
│   │                     │ • Event History     │                                     │  │
│   │                     │ • Workflow 상태     │                                     │  │
│   │                     │ • Task Queue 상태   │                                     │  │
│   │                     └─────────────────────┘                                     │  │
│   │                                                                                  │  │
│   └──────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                                                                  │  │
│   │   Temporal UI (포트: 21088)                                                     │  │
│   │   ═════════════════════════                                                      │  │
│   │   • Workflow 실행 상태 조회                                                     │  │
│   │   • Event History 시각화                                                        │  │
│   │   • 디버깅 및 모니터링                                                          │  │
│   │                                                                                  │  │
│   └──────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                              MSA 서비스들 (비즈니스 로직)                               │
│                                                                                         │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   Activity가 HTTP로 호출                                                               │
│                                                                                         │
│   ┌──────────────────┐   ┌──────────────────┐   ┌──────────────────┐                   │
│   │  service-order   │   │ service-inventory│   │ service-payment  │                   │
│   │   (포트: 21082)  │   │   (포트: 21083)  │   │   (포트: 21084)  │                   │
│   │                  │   │                  │   │                  │                   │
│   │ • 주문 생성     │   │ • 재고 예약     │   │ • 결제 생성     │                   │
│   │ • 주문 확정     │   │ • 재고 확정     │   │ • 결제 승인     │                   │
│   │ • 주문 취소     │   │ • 재고 취소     │   │ • 결제 확정     │                   │
│   │                  │   │ • Semantic Lock │   │ • 환불 처리     │                   │
│   │                  │   │ • RLock         │   │ • RSemaphore    │                   │
│   └────────┬─────────┘   └────────┬─────────┘   └────────┬─────────┘                   │
│            │                      │                      │                             │
│            │ JPA                  │ JPA                  │ JPA                         │
│            ▼                      ▼                      ▼                             │
│   ┌──────────────────────────────────────────────────────────────────────────────┐     │
│   │                                                                               │     │
│   │   MySQL (포트: 21306)                           Redis (포트: 21379)          │     │
│   │                                                                               │     │
│   │   • orders 테이블                               • 멱등성 키 저장             │     │
│   │   • inventory 테이블                            • 분산 락 (RLock)            │     │
│   │   • payments 테이블                             • 세마포어 (RSemaphore)      │     │
│   │   • outbox 테이블                               • Redis Stream (MQ)          │     │
│   │                                                                               │     │
│   └──────────────────────────────────────────────────────────────────────────────┘     │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 컴포넌트별 역할 정리

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              컴포넌트별 역할 정리                                        │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │  Temporal 인프라 (Docker)                                                        │   │
│  ├─────────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                                  │   │
│  │  컴포넌트                 포트      역할                                         │   │
│  │  ─────────────────────────────────────────────────────────────────────────────  │   │
│  │  temporal-server         21733     Workflow 상태 관리, Task Queue 관리          │   │
│  │  temporal-postgresql     21432     Temporal 내부 데이터 저장 (Event History)    │   │
│  │  temporal-ui             21088     Workflow 모니터링 웹 UI                       │   │
│  │                                                                                  │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │  애플리케이션 (Spring Boot)                                                      │   │
│  ├─────────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                                  │   │
│  │  컴포넌트                 포트      역할                                         │   │
│  │  ─────────────────────────────────────────────────────────────────────────────  │   │
│  │  orchestrator-temporal   21081     Workflow 정의 + Worker 호스팅 + REST API     │   │
│  │  service-order           21082     주문 도메인 (CRUD)                           │   │
│  │  service-inventory       21083     재고 도메인 (예약/확정/취소)                 │   │
│  │  service-payment         21084     결제 도메인 (생성/승인/환불)                 │   │
│  │  service-notification    21085     알림 서비스 (Redis Stream Consumer)          │   │
│  │                                                                                  │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │  공유 인프라 (Docker)                                                            │   │
│  ├─────────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                                  │   │
│  │  컴포넌트                 포트      역할                                         │   │
│  │  ─────────────────────────────────────────────────────────────────────────────  │   │
│  │  mysql                   21306     애플리케이션 데이터 (주문/재고/결제)         │   │
│  │  redis                   21379     캐시, 분산 락, 멱등성 키, MQ                 │   │
│  │                                                                                  │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 주문 처리 상세 흐름도

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                           주문 처리 상세 흐름도                                         │
│                                                                                         │
│  ※ 번호는 실행 순서를 나타냅니다                                                       │
│                                                                                         │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│                                                                                         │
│   Client                                                                                │
│     │                                                                                   │
│     │ ① POST /api/temporal/orders                                                      │
│     │    {customerId:1, productId:1, quantity:2, amount:20000}                         │
│     ▼                                                                                   │
│  ┌──────────────────────────────────────────────────────────────────────────────────┐  │
│  │                                                                                   │  │
│  │  orchestrator-temporal (:21081)                                                  │  │
│  │                                                                                   │  │
│  │  ┌─────────────────────────────────────────────────────────────────────────────┐│  │
│  │  │                        OrderController                                       ││  │
│  │  │                                                                              ││  │
│  │  │  ② WorkflowClient.newWorkflowStub(OrderWorkflow.class, options)             ││  │
│  │  │  ③ workflow.processOrder(request)  ──────────────────────────────────┐      ││  │
│  │  │                                                                       │      ││  │
│  │  └───────────────────────────────────────────────────────────────────────┼──────┘│  │
│  │                                                                          │       │  │
│  └──────────────────────────────────────────────────────────────────────────┼───────┘  │
│                                                                             │          │
│                                                                             │ gRPC     │
│                                                                             │          │
│  ┌──────────────────────────────────────────────────────────────────────────┼───────┐  │
│  │                                                                          │       │  │
│  │  Temporal Server (:21733)                                               │       │  │
│  │                                                                          │       │  │
│  │  ④ StartWorkflowExecution 수신 ◄─────────────────────────────────────────┘       │  │
│  │     │                                                                            │  │
│  │     │ Event 생성:                                                                │  │
│  │     │ • WorkflowExecutionStarted                                                │  │
│  │     │ • WorkflowTaskScheduled                                                   │  │
│  │     │                                                                            │  │
│  │     ▼                                                                            │  │
│  │  ┌───────────────────────────────────────────┐                                  │  │
│  │  │         Task Queue: "order-task-queue"    │                                  │  │
│  │  │                                           │                                  │  │
│  │  │  ┌─────────────────────────────────────┐  │                                  │  │
│  │  │  │ [Workflow Task]                     │  │  ◄───── ⑤ Task 추가             │  │
│  │  │  │  workflowId: "order-abc123"         │  │                                  │  │
│  │  │  │  taskType: WORKFLOW                 │  │                                  │  │
│  │  │  └─────────────────────────────────────┘  │                                  │  │
│  │  │                                           │                                  │  │
│  │  └─────────────────────┬─────────────────────┘                                  │  │
│  │                        │                                                         │  │
│  └────────────────────────┼─────────────────────────────────────────────────────────┘  │
│                           │                                                            │
│                           │ ⑥ Long Polling (Task 전달)                                │
│                           │                                                            │
│  ┌────────────────────────┼─────────────────────────────────────────────────────────┐  │
│  │                        ▼                                                          │  │
│  │  orchestrator-temporal - Worker                                                  │  │
│  │                                                                                   │  │
│  │  ┌─────────────────────────────────────────────────────────────────────────────┐│  │
│  │  │                     Workflow Executor                                        ││  │
│  │  │                                                                              ││  │
│  │  │  ⑦ OrderWorkflowImpl.processOrder(request) 실행                             ││  │
│  │  │                                                                              ││  │
│  │  │     // T1: 주문 생성                                                         ││  │
│  │  │     orderId = activities.createOrder(customerId);                           ││  │
│  │  │                    │                                                         ││  │
│  │  │                    │ SDK가 Command 생성                                      ││  │
│  │  │                    ▼                                                         ││  │
│  │  │     Command: ScheduleActivityTask(createOrder) ───────────────────────┐     ││  │
│  │  │                                                                        │     ││  │
│  │  └────────────────────────────────────────────────────────────────────────┼─────┘│  │
│  │                                                                           │      │  │
│  └───────────────────────────────────────────────────────────────────────────┼──────┘  │
│                                                                              │         │
│                                                                              │ gRPC    │
│                                                                              │         │
│  ┌───────────────────────────────────────────────────────────────────────────┼──────┐  │
│  │                                                                           │      │  │
│  │  Temporal Server                                                         │      │  │
│  │                                                                           │      │  │
│  │  ⑧ Command 수신 ◄─────────────────────────────────────────────────────────┘      │  │
│  │     │                                                                            │  │
│  │     │ Event 생성:                                                                │  │
│  │     │ • WorkflowTaskCompleted                                                   │  │
│  │     │ • ActivityTaskScheduled (createOrder)                                     │  │
│  │     │                                                                            │  │
│  │     ▼                                                                            │  │
│  │  ┌───────────────────────────────────────────┐                                  │  │
│  │  │         Task Queue: "order-task-queue"    │                                  │  │
│  │  │                                           │                                  │  │
│  │  │  ┌─────────────────────────────────────┐  │                                  │  │
│  │  │  │ [Activity Task]                     │  │  ◄───── ⑨ Task 추가             │  │
│  │  │  │  activityType: "createOrder"        │  │                                  │  │
│  │  │  │  input: [1]                         │  │                                  │  │
│  │  │  └─────────────────────────────────────┘  │                                  │  │
│  │  │                                           │                                  │  │
│  │  └─────────────────────┬─────────────────────┘                                  │  │
│  │                        │                                                         │  │
│  └────────────────────────┼─────────────────────────────────────────────────────────┘  │
│                           │                                                            │
│                           │ ⑩ Long Polling (Task 전달)                                │
│                           │                                                            │
│  ┌────────────────────────┼─────────────────────────────────────────────────────────┐  │
│  │                        ▼                                                          │  │
│  │  orchestrator-temporal - Worker                                                  │  │
│  │                                                                                   │  │
│  │  ┌─────────────────────────────────────────────────────────────────────────────┐│  │
│  │  │                     Activity Executor                                        ││  │
│  │  │                                                                              ││  │
│  │  │  ⑪ OrderActivitiesImpl.createOrder(1) 실행                                  ││  │
│  │  │                                                                              ││  │
│  │  │     public Long createOrder(Long customerId) {                              ││  │
│  │  │         // HTTP 호출!                                                        ││  │
│  │  │         response = orderClient.post()                                       ││  │
│  │  │             .uri("/api/orders")                                             ││  │
│  │  │             .body(Map.of("customerId", customerId))  ────────────────┐      ││  │
│  │  │             .retrieve();                                              │      ││  │
│  │  │                                                                       │      ││  │
│  │  │         return response.get("orderId");  // 123                       │      ││  │
│  │  │     }                                                                 │      ││  │
│  │  │                                                                       │      ││  │
│  │  └───────────────────────────────────────────────────────────────────────┼──────┘│  │
│  │                                                                          │       │  │
│  └──────────────────────────────────────────────────────────────────────────┼───────┘  │
│                                                                             │          │
│                                                                             │ ⑫ HTTP  │
│                                                                             │   POST   │
│                                                                             │          │
│  ┌──────────────────────────────────────────────────────────────────────────┼───────┐  │
│  │                                                                          │       │  │
│  │  service-order (:21082)                                                 │       │  │
│  │                                                                          ▼       │  │
│  │  ┌─────────────────────────────────────────────────────────────────────────────┐│  │
│  │  │                        OrderController                                       ││  │
│  │  │                                                                              ││  │
│  │  │  ⑬ createOrder(customerId=1) 수신                                           ││  │
│  │  │     │                                                                        ││  │
│  │  │     ▼                                                                        ││  │
│  │  │  OrderService.createOrder()                                                  ││  │
│  │  │     │                                                                        ││  │
│  │  │     ▼                                                                        ││  │
│  │  │  Order entity = new Order(customerId);                                      ││  │
│  │  │  orderRepository.save(entity);  ──────────────────────┐                     ││  │
│  │  │                                                        │                     ││  │
│  │  │  return {orderId: 123, status: "CREATED"} ◄────────────┼─ ⑮ 응답           ││  │
│  │  │                                                        │                     ││  │
│  │  └────────────────────────────────────────────────────────┼─────────────────────┘│  │
│  │                                                           │                      │  │
│  └───────────────────────────────────────────────────────────┼──────────────────────┘  │
│                                                              │                         │
│                                                              │ ⑭ INSERT               │
│                                                              ▼                         │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                                    │ │
│  │  MySQL (:21306)                                                                   │ │
│  │                                                                                    │ │
│  │  orders 테이블:                                                                   │ │
│  │  ┌─────────────────────────────────────────────────────────────────────────────┐ │ │
│  │  │ id  │ customer_id │ status  │ created_at          │ version │              │ │ │
│  │  │─────┼─────────────┼─────────┼─────────────────────┼─────────┼──────────────│ │ │
│  │  │ 123 │ 1           │ CREATED │ 2026-02-05 10:00:00 │ 0       │              │ │ │
│  │  └─────────────────────────────────────────────────────────────────────────────┘ │ │
│  │                                                                                    │ │
│  └───────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                         │
│                                                                                         │
│  (이후 T2: reserveStock, T3: payment 등 같은 패턴으로 반복)                            │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. T1~T6 전체 Activity 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                          T1~T6 전체 Activity 흐름                                       │
│                                                                                         │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│                                                                                         │
│   orchestrator-temporal                           MSA Services                          │
│   (Worker)                                                                              │
│       │                                                                                 │
│       │                                                                                 │
│   ════╪══════════════════════════════════════════════════════════════════════════════  │
│       │                                                                                 │
│       │  T1: createOrder                                                               │
│       │  ─────────────────                                                              │
│       ├─────────────────────────────────────────────────────┐                          │
│       │  Activity: createOrder(customerId=1)                │                          │
│       │                                                      │                          │
│       │                                                      │ HTTP POST               │
│       │                                                      ▼                          │
│       │                                     ┌─────────────────────────────┐            │
│       │                                     │  service-order (:21082)     │            │
│       │                                     │  POST /api/orders           │            │
│       │                                     │  → orderId: 123             │            │
│       │  ◄──────────────────────────────────┤                             │            │
│       │  결과: orderId = 123                └─────────────────────────────┘            │
│       │                                                                                 │
│   ════╪══════════════════════════════════════════════════════════════════════════════  │
│       │                                                                                 │
│       │  T2: reserveStock                                                              │
│       │  ─────────────────                                                              │
│       ├─────────────────────────────────────────────────────┐                          │
│       │  Activity: reserveStock(productId=1, qty=2, sagaId) │                          │
│       │                                                      │                          │
│       │                                                      │ HTTP POST               │
│       │                                                      ▼                          │
│       │                                     ┌─────────────────────────────┐            │
│       │                                     │  service-inventory (:21083) │            │
│       │                                     │  POST /api/inventory/1/     │            │
│       │                                     │       reserve?qty=2&sagaId= │            │
│       │                                     │                             │            │
│       │                                     │  내부 처리:                 │            │
│       │                                     │  • RLock 획득               │            │
│       │                                     │  • Semantic Lock 설정       │            │
│       │                                     │  • 재고 차감                │            │
│       │                                     │  • @Version 체크            │            │
│       │  ◄──────────────────────────────────┤  → 성공                     │            │
│       │  결과: void (성공)                  └─────────────────────────────┘            │
│       │                                                                                 │
│   ════╪══════════════════════════════════════════════════════════════════════════════  │
│       │                                                                                 │
│       │  T3-1: createPayment                                                           │
│       │  ─────────────────────                                                          │
│       ├─────────────────────────────────────────────────────┐                          │
│       │  Activity: createPayment(orderId, amount, method,   │                          │
│       │                          sagaId)                    │                          │
│       │                                                      │ HTTP POST               │
│       │                                                      ▼                          │
│       │                                     ┌─────────────────────────────┐            │
│       │                                     │  service-payment (:21084)   │            │
│       │                                     │  POST /api/payments         │            │
│       │                                     │  {orderId:123, amount:20000}│            │
│       │  ◄──────────────────────────────────┤  → paymentId: 456           │            │
│       │  결과: paymentId = 456              └─────────────────────────────┘            │
│       │                                                                                 │
│   ════╪══════════════════════════════════════════════════════════════════════════════  │
│       │                                                                                 │
│       │  T3-2: approvePayment                                                          │
│       │  ──────────────────────                                                         │
│       ├─────────────────────────────────────────────────────┐                          │
│       │  Activity: approvePayment(paymentId=456, sagaId)    │                          │
│       │                                                      │                          │
│       │                                                      │ HTTP POST               │
│       │                                                      ▼                          │
│       │                                     ┌─────────────────────────────┐            │
│       │                                     │  service-payment (:21084)   │            │
│       │                                     │  POST /api/payments/456/    │            │
│       │                                     │       approve               │            │
│       │                                     │                             │            │
│       │                                     │  내부 처리:                 │            │
│       │                                     │  • RSemaphore 획득 (PG 제한)│            │
│       │                                     │  • FakePaymentGateway 호출  │            │
│       │                                     │  • 상태: APPROVED           │            │
│       │  ◄──────────────────────────────────┤  → 성공                     │            │
│       │  결과: void (성공)                  └─────────────────────────────┘            │
│       │                                                                                 │
│   ════╪══════════════════════════════════════════════════════════════════════════════  │
│       │                                                                                 │
│       │  T4: confirmOrder                                                              │
│       │  ──────────────────                                                             │
│       ├─────────────────────────────────────────────────────┐                          │
│       │  Activity: confirmOrder(orderId=123)                │                          │
│       │                                                      │ HTTP PATCH              │
│       │                                                      ▼                          │
│       │                                     ┌─────────────────────────────┐            │
│       │                                     │  service-order (:21082)     │            │
│       │                                     │  PATCH /api/orders/123/     │            │
│       │                                     │        confirm              │            │
│       │                                     │  → status: CONFIRMED        │            │
│       │  ◄──────────────────────────────────┤                             │            │
│       │  결과: void (성공)                  └─────────────────────────────┘            │
│       │                                                                                 │
│   ════╪══════════════════════════════════════════════════════════════════════════════  │
│       │                                                                                 │
│       │  T5: confirmReservation                                                        │
│       │  ────────────────────────                                                       │
│       ├─────────────────────────────────────────────────────┐                          │
│       │  Activity: confirmReservation(productId, qty, sagaId)                          │
│       │                                                      │ HTTP POST               │
│       │                                                      ▼                          │
│       │                                     ┌─────────────────────────────┐            │
│       │                                     │  service-inventory (:21083) │            │
│       │                                     │  POST /api/inventory/1/     │            │
│       │                                     │       confirm               │            │
│       │                                     │  → Semantic Lock 해제       │            │
│       │  ◄──────────────────────────────────┤                             │            │
│       │  결과: void (성공)                  └─────────────────────────────┘            │
│       │                                                                                 │
│   ════╪══════════════════════════════════════════════════════════════════════════════  │
│       │                                                                                 │
│       │  T6: confirmPayment                                                            │
│       │  ────────────────────                                                           │
│       ├─────────────────────────────────────────────────────┐                          │
│       │  Activity: confirmPayment(paymentId=456, sagaId)    │                          │
│       │                                                      │ HTTP POST               │
│       │                                                      ▼                          │
│       │                                     ┌─────────────────────────────┐            │
│       │                                     │  service-payment (:21084)   │            │
│       │                                     │  POST /api/payments/456/    │            │
│       │                                     │       confirm               │            │
│       │                                     │  → status: CONFIRMED        │            │
│       │  ◄──────────────────────────────────┤                             │            │
│       │  결과: void (성공)                  └─────────────────────────────┘            │
│       │                                                                                 │
│   ════╪══════════════════════════════════════════════════════════════════════════════  │
│       │                                                                                 │
│       │  Workflow 완료                                                                 │
│       │  ──────────────                                                                 │
│       │  return OrderResult.success(orderId=123, paymentId=456, workflowId)            │
│       │                                                                                 │
│       ▼                                                                                 │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 데이터 흐름도

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                              데이터 저장 위치 정리                                       │
│                                                                                         │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                                                                  │  │
│   │  Temporal PostgreSQL (:21432)                                                   │  │
│   │  ════════════════════════════                                                    │  │
│   │                                                                                  │  │
│   │  저장 데이터:                                                                   │  │
│   │  • Event History (WorkflowExecutionStarted, ActivityTaskCompleted, ...)        │  │
│   │  • Workflow 상태 (Running, Completed, Failed)                                  │  │
│   │  • Task Queue 메타데이터                                                        │  │
│   │  • Timer 정보                                                                   │  │
│   │                                                                                  │  │
│   │  용도:                                                                          │  │
│   │  • Workflow 상태 추적                                                          │  │
│   │  • 크래시 복구 (Event Replay)                                                  │  │
│   │  • 모니터링 및 감사                                                            │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                                                                  │  │
│   │  MySQL (:21306)                                                                 │  │
│   │  ═══════════════                                                                 │  │
│   │                                                                                  │  │
│   │  저장 데이터:                                                                   │  │
│   │  • orders (주문 정보)                                                          │  │
│   │  • inventory (재고 정보)                                                       │  │
│   │  • payments (결제 정보)                                                        │  │
│   │  • outbox_events (Outbox 패턴)                                                 │  │
│   │                                                                                  │  │
│   │  용도:                                                                          │  │
│   │  • 실제 비즈니스 데이터 저장                                                   │  │
│   │  • 각 MSA 서비스의 도메인 데이터                                               │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                                                                  │  │
│   │  Redis (:21379)                                                                 │  │
│   │  ═══════════════                                                                 │  │
│   │                                                                                  │  │
│   │  저장 데이터:                                                                   │  │
│   │  • idempotency:{key} (멱등성 키 + 결과 캐시)                                   │  │
│   │  • lock:inventory:{productId} (RLock)                                          │  │
│   │  • semaphore:pg (RSemaphore - PG 호출 제한)                                    │  │
│   │  • stream:order-events (Redis Stream - MQ)                                     │  │
│   │                                                                                  │  │
│   │  용도:                                                                          │  │
│   │  • 중복 요청 방지 (멱등성)                                                     │  │
│   │  • 동시성 제어 (분산 락)                                                       │  │
│   │  • Rate Limiting (세마포어)                                                    │  │
│   │  • 비동기 메시지 (MQ)                                                          │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
│                                                                                         │
│   데이터 흐름 요약:                                                                    │
│   ══════════════════                                                                    │
│                                                                                         │
│   Client                                                                                │
│     │                                                                                   │
│     │ ① 주문 요청                                                                      │
│     ▼                                                                                   │
│   orchestrator-temporal                                                                │
│     │                                                                                   │
│     ├───────────────────────────────────────────────────────────────────┐              │
│     │ ② Workflow 시작                                                   │              │
│     │    Event History 저장                                             ▼              │
│     │                                                          Temporal PostgreSQL     │
│     │                                                          (Workflow 상태)         │
│     │                                                                                   │
│     ├───────────────────────────────────────────────────────────────────┐              │
│     │ ③ Activity 실행                                                   │              │
│     │    MSA 서비스 호출                                                ▼              │
│     │                                                             MSA Services         │
│     │                                                                   │              │
│     │                                              ┌────────────────────┼────────┐     │
│     │                                              │                    │        │     │
│     │                                              ▼                    ▼        ▼     │
│     │                                            MySQL               Redis    Redis    │
│     │                                         (비즈니스)           (멱등성)   (락)    │
│     │                                                                                   │
│     ▼                                                                                   │
│   Client (응답)                                                                        │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 실패 시 보상 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                          실패 시 보상 트랜잭션 흐름                                      │
│                                                                                         │
│  시나리오: T3 (결제 승인)에서 실패 → 보상 실행                                         │
│                                                                                         │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│                                                                                         │
│   orchestrator-temporal                           MSA Services                          │
│   (Worker)                                                                              │
│       │                                                                                 │
│       │  ════════════ 정방향 (Forward) ════════════                                    │
│       │                                                                                 │
│       │  T1: createOrder ─────────────────────────────────►  service-order             │
│       │      orderId = 123 ◄──────────────────────────────   ✅ 성공                   │
│       │      saga.addCompensation(cancelOrder)                                         │
│       │                                                                                 │
│       │  T2: reserveStock ────────────────────────────────►  service-inventory         │
│       │      ◄────────────────────────────────────────────   ✅ 성공                   │
│       │      saga.addCompensation(cancelReservation)                                   │
│       │                                                                                 │
│       │  T3-1: createPayment ─────────────────────────────►  service-payment           │
│       │        paymentId = 456 ◄──────────────────────────   ✅ 성공                   │
│       │        saga.addCompensation(refundPayment)                                     │
│       │                                                                                 │
│       │  T3-2: approvePayment ────────────────────────────►  service-payment           │
│       │        ◄──────────────────────────────────────────   ❌ 실패!                  │
│       │                                                       (잔액 부족)              │
│       │                                                                                 │
│       │  ════════════ 보상 (Compensation) ════════════                                 │
│       │                                                                                 │
│       │  catch (ActivityFailure e) {                                                   │
│       │      saga.compensate();  // 자동 역순 실행!                                    │
│       │  }                                                                              │
│       │                                                                                 │
│       │  보상 스택 (LIFO):                                                             │
│       │  ┌───────────────────────┐                                                     │
│       │  │ refundPayment         │ ← 가장 마지막 등록                                  │
│       │  │ cancelReservation     │                                                     │
│       │  │ cancelOrder           │ ← 가장 처음 등록                                    │
│       │  └───────────────────────┘                                                     │
│       │                                                                                 │
│       │  C3: refundPayment ───────────────────────────────►  service-payment           │
│       │      (paymentId=456)                                  POST /payments/456/refund│
│       │      ◄────────────────────────────────────────────   ✅ 환불 완료              │
│       │                                                                                 │
│       │  C2: cancelReservation ───────────────────────────►  service-inventory         │
│       │      (productId=1, qty=2, sagaId)                     POST /inventory/1/cancel │
│       │      ◄────────────────────────────────────────────   ✅ 재고 복구              │
│       │                                                                                 │
│       │  C1: cancelOrder ─────────────────────────────────►  service-order             │
│       │      (orderId=123)                                    PATCH /orders/123/cancel │
│       │      ◄────────────────────────────────────────────   ✅ 주문 취소              │
│       │                                                                                 │
│       │  ════════════════════════════════════════════════════                          │
│       │                                                                                 │
│       │  return OrderResult.failure("잔액 부족", workflowId)                           │
│       │                                                                                 │
│       ▼                                                                                 │
│                                                                                         │
│                                                                                         │
│   최종 상태:                                                                           │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                                                                  │  │
│   │  orders 테이블:        id=123, status=CANCELLED                                 │  │
│   │  inventory 테이블:     productId=1, quantity=100 (원래대로 복구)                │  │
│   │  payments 테이블:      id=456, status=REFUNDED                                  │  │
│   │                                                                                  │  │
│   │  Workflow 상태:        Completed (비즈니스 실패지만 Workflow는 정상 종료)       │  │
│   │  결과:                 {success: false, error: "잔액 부족"}                     │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 요약: 핵심 통신 경로

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                              핵심 통신 경로 요약                                        │
│                                                                                         │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│                                                                                         │
│   ┌─────────┐     HTTP      ┌─────────────────────────────────────────────────────┐   │
│   │ Client  │ ────────────► │            orchestrator-temporal                    │   │
│   └─────────┘               │                  (:21081)                           │   │
│                             │                                                      │   │
│                             │   ┌─────────────┐        ┌─────────────────────┐    │   │
│                             │   │ Controller  │        │       Worker        │    │   │
│                             │   │             │        │                     │    │   │
│                             │   │ • REST API  │        │ • Workflow Executor │    │   │
│                             │   │   수신      │        │ • Activity Executor │    │   │
│                             │   └──────┬──────┘        └──────────┬──────────┘    │   │
│                             │          │                          │               │   │
│                             └──────────┼──────────────────────────┼───────────────┘   │
│                                        │                          │                   │
│                                        │ gRPC                     │ gRPC              │
│                                        │ (Start                   │ (Poll/            │
│                                        │  Workflow)               │  Result)          │
│                                        │                          │                   │
│                                        ▼                          ▼                   │
│                             ┌─────────────────────────────────────────────────────┐   │
│                             │                                                      │   │
│                             │              Temporal Server (:21733)               │   │
│                             │                                                      │   │
│                             │   • Task Queue 관리                                 │   │
│                             │   • Event History 저장                              │   │
│                             │   • Workflow 상태 관리                              │   │
│                             │                                                      │   │
│                             └───────────────────────┬─────────────────────────────┘   │
│                                                     │                                 │
│                                                     │ SQL                             │
│                                                     ▼                                 │
│                             ┌─────────────────────────────────────────────────────┐   │
│                             │         Temporal PostgreSQL (:21432)                │   │
│                             └─────────────────────────────────────────────────────┘   │
│                                                                                         │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                                                                  │  │
│   │  Activity 실행 시 HTTP 호출:                                                    │  │
│   │                                                                                  │  │
│   │  Worker ────── HTTP ──────► service-order     (:21082)  ───► MySQL (:21306)    │  │
│   │         │                                                                        │  │
│   │         ├──── HTTP ──────► service-inventory (:21083)  ───► MySQL + Redis      │  │
│   │         │                                                                        │  │
│   │         └──── HTTP ──────► service-payment   (:21084)  ───► MySQL + Redis      │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
│                                                                                         │
│   통신 프로토콜 정리:                                                                  │
│   ═══════════════════                                                                   │
│                                                                                         │
│   ┌────────────────────────────┬─────────────────────────────────────────────────────┐│
│   │  경로                      │  프로토콜                                           ││
│   ├────────────────────────────┼─────────────────────────────────────────────────────┤│
│   │  Client → Orchestrator     │  HTTP (REST API)                                   ││
│   │  Orchestrator → Temporal   │  gRPC (Temporal SDK)                               ││
│   │  Worker ↔ Temporal         │  gRPC (Long Polling, Result Report)               ││
│   │  Worker → MSA Services     │  HTTP (REST API)                                   ││
│   │  MSA Services → MySQL      │  JDBC                                              ││
│   │  MSA Services → Redis      │  Redis Protocol (Redisson)                        ││
│   │  Temporal → PostgreSQL     │  SQL                                               ││
│   └────────────────────────────┴─────────────────────────────────────────────────────┘│
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. 포트 정리

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              포트 정리 (21000번대)                                      │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   ┌────────────────────────────┬─────────┬───────────────────────────────────────────┐ │
│   │  서비스                    │  포트   │  설명                                     │ │
│   ├────────────────────────────┼─────────┼───────────────────────────────────────────┤ │
│   │  MySQL                     │  21306  │  애플리케이션 DB (주문/재고/결제)         │ │
│   │  Redis                     │  21379  │  캐시, 분산 락, 멱등성, MQ               │ │
│   │  Temporal Server (gRPC)    │  21733  │  Temporal SDK 연결용                     │ │
│   │  Temporal PostgreSQL       │  21432  │  Temporal 내부 데이터                    │ │
│   │  Temporal UI               │  21088  │  Workflow 모니터링 웹                    │ │
│   ├────────────────────────────┼─────────┼───────────────────────────────────────────┤ │
│   │  orchestrator-pure         │  21080  │  순수 Saga 오케스트레이터                │ │
│   │  orchestrator-temporal     │  21081  │  Temporal 기반 오케스트레이터            │ │
│   │  service-order             │  21082  │  주문 서비스                             │ │
│   │  service-inventory         │  21083  │  재고 서비스                             │ │
│   │  service-payment           │  21084  │  결제 서비스                             │ │
│   │  service-notification      │  21085  │  알림 서비스                             │ │
│   └────────────────────────────┴─────────┴───────────────────────────────────────────┘ │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

*이전 문서: `03-temporal-worker-event-flow.md`*
